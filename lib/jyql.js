// Generated by CoffeeScript 1.4.0
(function() {
  var IS_NODE, browser_fetch, jyql, nodejs_fetch, request;

  IS_NODE = typeof module !== 'undefined' && (module.exports != null);

  /* ***************************************************************************
  Browser only
  ***************************************************************************
  */


  if (!IS_NODE) {
    browser_fetch = function(query, callback) {
      var addScript, callbackFunctionSource, randomName,
        _this = this;
      addScript = function(script, callback) {
        var headID, newScript,
          _this = this;
        headID = document.getElementsByTagName("head")[0];
        newScript = document.createElement('script');
        newScript.type = 'text/javascript';
        if ((script.match(/^http[\s\S]*/)) != null) {
          newScript.src = script;
          newScript.onload = function() {
            return callback(null);
          };
          headID.appendChild(newScript);
        } else {
          newScript.innerHTML = script;
          headID.appendChild(newScript);
          callback(null);
        }
        return null;
      };
      randomName = 'jyql_' + Math.random().toString(36).substr(2, 7);
      callbackFunctionSource = "var " + randomName + "_data = { };\nvar " + randomName + "_function = function (data) { " + randomName + "_data = data; };";
      return addScript(callbackFunctionSource, function() {
        var protocol, _ref, _ref1, _ref2;
        protocol = "http" || (typeof window !== "undefined" && window !== null ? (_ref = window.parent) != null ? (_ref1 = _ref.document) != null ? (_ref2 = _ref1.location) != null ? _ref2.protocol : void 0 : void 0 : void 0 : void 0);
        return addScript(protocol + "://query.yahooapis.com/v1/public/yql?format=json&callback=" + escape(randomName + '_function') + "&q=" + escape(query), function(err) {
          return callback(err, eval(randomName + '_data'));
        });
      });
    };
  }

  /* ***************************************************************************
  Node.js only
  ***************************************************************************
  */


  if (IS_NODE) {
    request = require('request');
    nodejs_fetch = function(query, callback) {
      var requestURL,
        _this = this;
      requestURL = "http://query.yahooapis.com/v1/public/yql?format=json&q=" + escape(query);
      return request(requestURL, function(err, response, body) {
        var data;
        data = null;
        if (!err && response.statusCode === 200) {
          try {
            data = JSON.parse(body);
          } catch (err2) {
            err = new Error('YQL returned data that is not valid JSON');
          }
        }
        return callback(err, data);
      });
    };
  }

  /* ***************************************************************************
  Common
  ***************************************************************************
  */


  jyql = function(query, callback) {
    var processYQLOutput,
      _this = this;
    processYQLOutput = function(err, data) {
      if (!err && (data != null ? data.error : void 0)) {
        err = new Error(data.error.description);
      }
      return callback(err, data);
    };
    if (!(callback != null) || typeof callback !== 'function') {
      return null;
    }
    if (!(query != null) || query === '') {
      return callback(new Error('No query was specified'), null);
    }
    if (IS_NODE) {
      return nodejs_fetch(query, processYQLOutput);
    }
    return browser_fetch(query, processYQLOutput);
  };

  if (IS_NODE) {
    return module.exports = jyql;
  }

  this.jyql = jyql;

}).call(this);
